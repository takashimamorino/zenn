---
title: "gql-tag-operations-preset ã‚’ä½¿ã£ãŸ GraphQL ã® Fragment Colocation"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GraphQL"]
published: false
---

æ™®æ®µ GraphQL ã‚’ä½¿ã£ãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚’ã—ã¦ã„ã¾ã™ã€‚æœ€è¿‘ GraphQL Code Generator ã®è¨­å®šã‚’è¦‹ç›´ã—ã¦ãŠã‚Šã€ã„ãã¤ã‹ã® plugin ã‚„ preset ã‚’æ¡ç”¨ã—ãŸã‚Šå‰Šé™¤ã—ãŸã®ã§ã™ãŒã€ãã®ä¸­ã§ã‚‚ `gql-tag-operations-preset` ãŒã¨ã¦ã‚‚è‰¯ã‹ã£ãŸã®ã§ã€ã‚‚ã¨ã‚‚ã¨ã®æ§‹æˆã¨ `gql-tag-operations-preset` ã‚’å°å…¥ã—ãŸå¾Œã®æ§‹æˆã‚’æ¯”è¼ƒã—ã¦è¨˜äº‹ã«æ®‹ã—ã¦ãŠãã¾ã™ã€‚

ã¾ãŸã€ `gql-tag-operations-preset` ã‚’å°å…¥ã™ã‚‹ã“ã¨ã§ã€ Relay ä»¥å¤–ã® GraphQL Client ã§ã‚‚ Fragment Colocation ãŒæ‰±ã„ã‚„ã™ããªã‚Šã¾ã™ã€‚

ç§ã¯ Apollo ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã®ã§ Relay ã® Fragment Colocation ã‚’åŸå‰‡ã¨ã—ãŸé–‹ç™ºä½“é¨“ã‚’ç¾¨ã¾ã—ãæ€ã£ã¦ã„ãŸã®ã§ã™ãŒã€ Apollo ã§ã‚‚å°‘ã—è¿‘ã¥ã„ãŸé–‹ç™ºä½“é¨“ã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

https://www.graphql-code-generator.com/plugins/gql-tag-operations-preset

## gql-tag-operations-preset ã‚’å°å…¥ã™ã‚‹å‰ã®é–‹ç™º

`gql-tag-operations-preset` ã‚’å°å…¥ã™ã‚‹å‰ã¯ã€ä¸»ã« `typed-document-node` ã¨ `near-operation-file-preset` ã‚’ä½¿ã£ãŸã€ GraphQL ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¯ã‚¨ãƒªã‚’è¨˜è¿°ã—ã€åŒã˜éšå±¤ã« TypedDocumentNode ãŒç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãæ§‹æˆã‚’ã¨ã£ã¦ã„ã¾ã—ãŸã€‚
ã“ã‚Œã‚’å®Ÿéš›ã«ä½¿ç”¨ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ä½µã›ã¦åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å…¥ã‚Œã¦ãŠãã“ã¨ã§ã€ä½¿ã‚ãªããªã£ãŸã‚‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨å‰Šé™¤ã™ã‚‹é‹ç”¨ã«ã—ã¦ã„ã¾ã—ãŸã€‚

```bash
â””â”€â”€ Books
    â”œâ”€â”€ Books.tsx
    â”œâ”€â”€ books.generated.ts
    â””â”€â”€ books.graphql
```

ãã“ã¾ã§ä¸æº€ã¯ãªã‹ã£ãŸã®ã§ã™ãŒã€ã‚„ã¯ã‚Šã‚¯ã‚¨ãƒªã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã§ãã‚‹ã ã‘è¿‘ãã«ã¾ã¨ã‚ã¦ãŠããŸã„ã¨ã¯æ€ã£ã¦ã„ã¾ã—ãŸã€‚åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚‚è¨˜è¿°ã§ãã‚‹ã®ã§ã™ãŒã€ãã®å ´åˆã¯ãŸã ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡å­—åˆ—ã§ã—ã‹ãªãã€å‹ã®æ©æµã‚’å¾—ã‚‰ã‚Œãªã„ã®ã§ã‚¯ã‚¨ãƒªã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§è¨˜è¿°ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã—ãŸã€‚

## gql-tag-operations-preset ã‚’å°å…¥ã—ãŸå¾Œã®é–‹ç™º

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ãªã©ã€åŸºæœ¬çš„ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€šã‚Šãªã®ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

https://www.graphql-code-generator.com/plugins/gql-tag-operations-preset

ã“ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãã€å‹ã‚‚ã—ã£ã‹ã‚Šã¨åŠ¹ã„ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![](/images/4c284439135a0c/02.png)

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

`gql-tag-operations-preset` ã‚’å°å…¥ã™ã‚‹å‰ã¨æ¯”ã¹ã¦ã€ä½¿ç”¨ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚å°‘ãªããªã£ãŸã®ã§ã€GraphQL Code Generator ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®è¨˜è¿°é‡ã‚‚å°‘ãªããªã‚Šã¾ã—ãŸã€‚

#### gql-tag-operations-preset å°å…¥å‰

```codegen.yml
schema: introspection.json
documents: './**/*.graphql'
generates:
  src/types/graphql.tsx:
    plugins:
      - typescript
  ./:
    preset: near-operation-file
    presetConfig:
      extension: .ts
      baseTypesPath: src/types/graphql
    plugins:
      - typescript-operations
      - typed-document-node
```

#### gql-tag-operations-preset å°å…¥å¾Œ

```codegen.yml
schema: introspection.json
documents: 'src/**/*.tsx'
generates:
  src/gql/:
    preset: gql-tag-operations-preset
```

ä¾¿å®œä¸Šç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™

## Fragment Colocation

Fragment Colocation ã«ã¤ã„ã¦ã¯[ã“ã¡ã‚‰ã®è¨˜äº‹](https://gist.github.com/Quramy/566ea87d0121ceb8cd97ad9d14b63fd8#3-composition)ãŒã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚

```typescript
import { useFragment, FragmentType, gql } from "../../gql";

const BooksQuery = gql(/* GraphQL */ `
	query BooksQuery {
		books {
			id
			...BookFragment
		}
	}
`);

export const Books: VFC = () => {
	const { data } = useQuery(BooksQuery);

	return (
		<ul>
			{data.books.map((book) => (
				<li key={book.id}>
					<Book book={book} />
				</li>
			))}
		</ul>
	);
};

const BookFragment = gql(/* GraphQL */ `
	fragment BookFragment on Book {
		title
		author
	}
`);

type Props = {
	book: FragmentType<typeof BookFragment>;
};

export const Book: VFC<Props> = (props) => {
	const book = useFragment(BookFragment, props.book);

	return (
		<>
			<p>{book.title}</p>
			<p>{book.author}</p>
		</>
	);
};
```

Relay ãƒ©ã‚¤ã‚¯ãª `useFragment` ã‚‚ã‚ã‚Šã€ Fragment Colocation ãŒæ‰±ã„ã‚„ã™ããªã‚Šã¾ã—ãŸã€‚

ã¾ãŸ `fragmentMasking` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ `true` ã™ã‚‹ã“ã¨ã§ã€å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ãã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã«ã‚ˆã£ã¦è¨˜è¿°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ä¾å­˜é–¢ä¿‚ã«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](/images/4c284439135a0c/03.png)

![](/images/4c284439135a0c/04.png)

Books ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯ `BookFragment` ã®å€¤ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããªãã€ Book ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯ `BookFragment` ã§å®šç¾©ã•ã‚ŒãŸå€¤ã«ã—ã‹ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

## ã¯ã¾ã£ãŸãƒã‚¤ãƒ³ãƒˆ

`gql` é–¢æ•°ã‚’ Apollo ãªã©ã®ä»–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚‚ã®ã‹ã‚‰ä½¿ãˆã‚‹ `augmentedModuleName` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã®ã§ã™ãŒã€ã“ã‚Œã¨ `fragmentMasking` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½µç”¨ã™ã‚‹ã¨ã€ fragment ã®å®šç¾©ã‚’èª­ã¿è¾¼ã‚ãšã«ã‚µãƒ¼ãƒãƒ¼ãŒã‚¯ã‚¨ãƒªã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ããªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

## å‚è€ƒ

- [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.graphql-code-generator.com/plugins/gql-tag-operations-preset)
- [GraphQL ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®å®Ÿè£…æŒ‡é‡](https://gist.github.com/Quramy/566ea87d0121ceb8cd97ad9d14b63fd8#file-graphql-md)
- [n1ru4l/character-overlay#331](https://github.com/n1ru4l/character-overlay/pull/331)
